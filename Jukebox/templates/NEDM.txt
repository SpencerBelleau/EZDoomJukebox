#library "NEDM"
#include "zcommon.acs"

<<MUSICSTRINGS>>
<<MUSICNAMES>>
//This is no longer needed since it doesn't work properly anyway
//will remove later
//<<MUSICLENGTHS>>
int tracks = <<NUMTRACKS>>;
int tracknum = -1;
int oldtrackNum = 0;

script "NEDM" OPEN
{
	while(1)
	{
		//Patented retard logic to avoid replays
		if(tracknum == -1 && tracks > 1)
		{
			tracknum = random(0, tracks - 1);
		}
		else if(tracks > 1)
		{
			oldtrackNum = tracknum;
			while(tracknum == oldtrackNum)
			{
				tracknum = random(0, tracks - 1);
			}
		}
		else
		{
			//you only got one song son wtf
			tracknum = 0;
		}
		if(GetCVar("ezjb_showOnscreenMessages") == 1)
		{
			SetFont("SMALLFONT");
			//improve this later, maybe with more templating
			HudMessage(	s:"\cqNOW PLAYING: \cd", s:songRealNames[tracknum];
						HUDMSG_PLAIN, 
						3485, //random to avoid collision
						CR_UNTRANSLATED,
						0.5,
						0.0,
						GetCVar("ezjb_textHoldTime") << 16); //pls work?
		}
		SetMusic(songNames[tracknum], 0);
		while(GetCVar("ezjb_next") == 0)
		{
			delay(5); //no need to make this more precise
		}
		SetCVar("ezjb_next", 0);
		//The fact that I have to do this amazes me a little
		int ensureNotBroken = 0;
		while(GetCVar("ezjb_next") != 0 && ensureNotBroken < 35)
		{
			delay(1);
			ensureNotBroken++;
		}
		if(GetCVar("ezjb_next") != 0)
		{
			Log(s:"Could not switch to next song");
			Log(d:GetCVar("ezjb_next"));
			break;
		}
	}
}